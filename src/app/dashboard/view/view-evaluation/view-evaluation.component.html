<div class="container-lg">
	<div class="row">
		<div class="col-3">
			<rd-card [cardTitle]="'View Evaluation - ' + currentDate.value">
				<input class="form-control" type="date" [formControl]="currentDate" />
			</rd-card>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<rd-card
				[cardTitle]="'Evaluation'"
				[expanded]="false"
				[isLoading]="loadingViewEvaluations$ | async"
			>
				<div class="row">
					<div class="col border-lightgrey border-right" [formGroup]="filterEvaluationForm">
						<div class="row form-group border-lightgrey border-bottom justify-content-center">
							<h6><b>Filter Evaluation View</b></h6>
						</div>
						<!-- <span class="row justify-content-end pr-2"><b>Filter</b></span> -->
						<div class="row form-group">
							<div class="col-4">
								<label for="evalTypeSearch" class="col-form-label font-weight-bold">
									Evaluation Type
								</label>
							</div>
							<div class="col">
								<ng-select
									[items]="evalType"
									placeholder="All"
									formControlName="evalType"
								></ng-select>
							</div>
						</div>
						<div class="row form-group">
							<div class="col-4">
								<label for="evalTypeSearch" class="col-form-label font-weight-bold"> Search </label>
							</div>
							<div class="col">
								<input class="form-control" formControlName="search" />
							</div>
						</div>
						<div class="row">
							<div class="col-3">
								<label class="col-form-label font-weight-bold"> Sort By </label>
							</div>
							<div class="col-1 mr-3">
								<button class="btn btn-primary" (click)="toggleSort()">
									{{ filterEvaluationForm.get('asc').value ? '&Delta;' : '&nabla;' }}
								</button>
							</div>
							<div class="col">
								<div class="row btn-group">
									<button
										class="btn btn-primary"
										[class.active]="sorter.value === 'Date'"
										(click)="sorter.setValue('Date')"
									>
										Date
									</button>
									<button
										class="btn btn-primary"
										[class.active]="sorter.value === 'Author'"
										(click)="sorter.setValue('Author')"
									>
										Author
									</button>
									<button
										class="btn btn-primary"
										[class.active]="sorter.value === 'Type'"
										(click)="sorter.setValue('Type')"
									>
										Type
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="col-7 col-flex">
						<div class="row form-group border-lightgrey border-bottom justify-content-center">
							<h6><b>Insert New Evaluation</b></h6>
						</div>
						<!-- <b class="row">Insert new Evaluation</b> -->
						<form class="row flex-grow-1" [formGroup]="insertEvaluationForm">
							<div class="col">
								<textarea
									class="form-control h-100"
									style="resize: none"
									placeholder="Notes"
									formControlName="notes"
								></textarea>
							</div>
							<div class="col-4 v-list-m-12 col-flex justify-content-center">
								<div class="row">
									<ng-select
										[items]="evalType"
										[clearable]="false"
										placeholder="Evaluation Type"
										formControlName="evalType"
									></ng-select>
								</div>
								<div class="row">
									<button
										type="submit"
										class="btn btn-block btn-primary"
										[disabled]="insertEvaluationForm.invalid"
									>
										Insert New Evaluation
									</button>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="row pt-2">
					<div
						class="col v-list-m-6 v-list-bordered border-lightgrey border-full-solid border-rad-8"
					>
						<div class="row" *ngFor="let note of filteredEvalNotes$ | async">
							<!-- Need extra col-row due to v-list-m-6 styling 
                prevents >1 child element -->
							<div class="col">
								<div class="row p-2">
									<div class="col">
										<div [innerHTML]="note.Notes.substring(note.Notes.indexOf('-') + 2)"></div>
										<div class="pl-4 pt-1">
											<span class="font-weight-bold">- {{ note.SavedBy }}</span>
											at {{ note.SavedAt | date: detailedViewDateFormat }}
										</div>
									</div>
									<div class="col-auto col-flex v-list-m-6">
										<div class="row">
											<div class="col text-right">
												<span class="badge badge-secondary badge-pill w-auto">
													{{ note.evalNoteType }}
												</span>
											</div>
										</div>
										<div class="row">
											<div class="col">
												<!-- *ngIf="note.IsDeleteAble" -->
												<rd-confirmable-pop-up *ngIf="note.IsDeleteAble">
													<!-- (confirm)="deleteNote(note)" -->
													<button class="btn btn-danger">
														<fa-icon [icon]="['far', 'trash-alt']"></fa-icon>
														Delete
													</button>
												</rd-confirmable-pop-up>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</rd-card>
		</div>
	</div>
	<div class="row">
		<div class="col-7">
			<!-- Can toggle the Presentation Detail to also minimized when this is minimized -->
			<rd-card
				[cardTitle]="'Today\'s Presentation'"
				[expanded]="false"
				(toggleExpand)="detailCard.toggleMinimized($event === false)"
				[isLoading]="loadingTodaysPresentation$ | async"
			>
				<div class="row justify-content-between">
					<span class="font-weight-bold">Session 1</span>
					<span>Passed: (3) Not Passed: (1)</span>
				</div>
				<table class="table table-sm table-striped table-hover text-center">
					<thead>
						<tr>
							<th>Trainee</th>
							<th>Date</th>
							<th>No</th>
							<th>Final Score</th>
							<th width="70px">Status</th>
							<th width="55px">PIC</th>
							<!-- <th width="100px">Actions</th> -->
						</tr>
					</thead>
					<tbody>
						<tr *ngIf="(todaysPresentation$ | async)?.length === 0">
							<td colspan="6">No votes yet</td>
						</tr>
						<tr
							*ngFor="let presentation of todaysPresentation$ | async"
							(click)="selectPresentation(presentation)"
							class="cursor-pointer"
						>
							<td>{{ presentation.traineeName }}</td>
							<td>{{ presentation.savedAt | date: 'dd-MM-yyyy HH:mm:ss' }}</td>
							<td>{{ presentation.presentationNo }}</td>
							<td>{{ presentation.score }}</td>
							<td>{{ presentation.status }}</td>
							<td>{{ presentation.savedBy }}</td>
						</tr>
					</tbody>
				</table>
				<div class="row justify-content-between">
					<span class="font-weight-bold">Session 2</span>
					<span>Passed: (3) Not Passed: (1)</span>
				</div>
				<table class="table table-sm table-striped table-hover text-center">
					<thead>
						<tr>
							<th>Trainee</th>
							<th>Date</th>
							<th>No</th>
							<th>Final Score</th>
							<th>Status</th>
							<th>PIC</th>
							<!-- <th width="100px">Actions</th> -->
						</tr>
					</thead>
					<tbody>
						<tr *ngIf="(todaysPresentation$ | async)?.length === 0">
							<td colspan="6">No votes yet</td>
						</tr>
						<tr
							*ngFor="let presentation of todaysPresentation$ | async"
							(click)="selectPresentation(presentation)"
							class="cursor-pointer"
						>
							<td>{{ presentation.traineeName }}</td>
							<td>{{ presentation.savedAt | date: 'dd-MM-yyyy HH:mm:ss' }}</td>
							<td>{{ presentation.presentationNo }}</td>
							<td>{{ presentation.score }}</td>
							<td>{{ presentation.status }}</td>
							<td>{{ presentation.savedBy }}</td>
						</tr>
					</tbody>
				</table>
			</rd-card>
		</div>
		<div class="col-5">
			<rd-card
				#detailCard
				[cardTitle]="'Presentation Detail'"
				[expanded]="presentationDetail$ | async"
				[collapsible]="presentationDetail$ | async"
			>
				<div class="row mb-4">
					<table class="table table-sm table-striped">
						<thead>
							<tr>
								<th colspan="2">Trainee Information</th>
								<!-- <th class="col-7"></th> -->
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Trainee</td>
								<td class="col-8">{{ (presentationDetail$ | async)?.traineeCode }}</td>
							</tr>
							<tr>
								<td>Trainee Name</td>
								<td>{{ (presentationDetail$ | async)?.traineeName }}</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="row">
					<table class="table table-sm table-striped">
						<thead>
							<tr>
								<th colspan="2">Presentation Result</th>
								<!-- <th></th> -->
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Material</td>
								<td class="col-8">{{ (presentationDetail$ | async)?.material }}</td>
							</tr>
							<tr>
								<td>Understanding</td>
								<td>{{ (presentationDetail$ | async)?.understanding }}</td>
							</tr>
							<tr>
								<td>Teaching Methodology</td>
								<td>{{ (presentationDetail$ | async)?.voice }}</td>
							</tr>
							<tr>
								<td>Class Control</td>
								<td>{{ (presentationDetail$ | async)?.classControl }}</td>
							</tr>
							<tr>
								<td>Final Score</td>
								<td>{{ (presentationDetail$ | async)?.score }}</td>
							</tr>
							<tr>
								<td>Status</td>
								<td>{{ (presentationDetail$ | async)?.status }}</td>
							</tr>
							<tr>
								<td>Notes</td>
								<td>{{ (presentationDetail$ | async)?.notes }}</td>
							</tr>
							<tr>
								<td>Comment</td>
								<td></td>
							</tr>
						</tbody>
					</table>
					<div [innerHTML]="(presentationDetail$ | async)?.comment"></div>
				</div>
			</rd-card>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<ng-template #editAttendanceTitle>Change Attendance</ng-template>
			<ng-template #editAttendanceContent>
				<div class="col" [formGroup]="changeAttendanceForm">
					<ng-select
						[items]="evalType"
						placeholder="Permission"
						[clearable]="false"
						formControlName=""
					></ng-select>
					<hr class="my-2" />
					<textarea class="form-control" cols="30" rows="4" formControlName=""></textarea>
					<div class="btn-group w-100">
						<button class="btn btn-sm btn-primary rounded-0">Update</button>
						<button class="btn btn-sm btn-secondary rounded-0">Cancel</button>
					</div>
				</div>
			</ng-template>
			<!-- eval-attendance => for attendance styling -->
			<rd-card
				[cardTitle]="'Attendance'"
				class="eval-attendance"
				[isLoading]="loadingViewAttendances$ | async"
			>
				<div class="row mb-3">
					<b>Legends: </b>
					<span class="Present legend"></span> OK <span class="Late legend"></span> Late / Early
					<span class="notDone legend"></span> Absent
					<span class="Permission legend"></span> Permission
					<span class="Neglects legend"></span> Neglects attendance
				</div>
				<table class="table table-sm table-striped text-center">
					<thead>
						<tr>
							<th rowspan="3">Trainee</th>
							<th colspan="4">Secretariat</th>
							<th colspan="4">Room</th>
							<th colspan="4">Rest</th>
							<th rowspan="3">Permission</th>
						</tr>
						<tr>
							<th colspan="2">Scheduled</th>
							<th colspan="2">Registered</th>
							<th colspan="2">Scheduled</th>
							<th colspan="2">Registered</th>
							<th colspan="2">Scheduled</th>
							<th colspan="2">Registered</th>
						</tr>
						<tr>
							<th>In</th>
							<th>Out</th>
							<th>In</th>
							<th>Out</th>
							<th>In</th>
							<th>Out</th>
							<th>In</th>
							<th>Out</th>
							<th>Out</th>
							<th>In</th>
							<th>Out</th>
							<th>In</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngIf="(attendanceReport$ | async)?.Attendances.length === 0">
							<td colspan="14">No data yet</td>
						</tr>
						<tr *ngFor="let at of (attendanceReport$ | async)?.Attendances">
							<td [ngClass]="{ Permission: at.FulldayPermission }" class="trainee-details-hotspot">
								<a [routerLink]="['#View/Trainee', at.TraineeId, 'false']" class="pointer relative">
									{{ at.TraineeCode }}
								</a>
							</td>
							<td>{{ at.Secretariat.TimeIn || '-' }}</td>
							<td>{{ at.Secretariat.TimeOut || '-' }}</td>
							<td
								class="{{ at.Secretariat.StatusAbsentIn || 'Absent' }}"
								[ngbPopover]="editAttendanceContent"
								[popoverTitle]="editAttendanceTitle"
								[autoClose]="'outside'"
								container="body"
							>
								<span
									[ngbPopover]="at.Secretariat.NoteIn"
									triggers="mouseenter:mouseleave"
									placement="bottom"
								>
									{{ (at.Secretariat.TraineeIn | date: 'HH:mm:ss') || '-' }}
								</span>
							</td>
							<td
								class="{{ at.Secretariat.StatusAbsentOut || 'Absent' }}"
								title="{{ at.Secretariat.NoteOut }}"
							>
								{{ (at.Secretariat.TraineeOut | date: 'HH:mm:ss') || '-' }}
							</td>
							<td>{{ at.Room.TimeIn || '-' }}</td>
							<td>{{ at.Room.TimeOut || '-' }}</td>
							<td class="{{ at.Room.StatusAbsentIn || 'Absent' }}">
								<span
									[ngbPopover]="at.Room.NoteIn"
									triggers="mouseenter:mouseleave"
									placement="bottom"
								>
									{{ (at.Room.TraineeIn | date: 'HH:mm:ss') || '-' }}
								</span>
							</td>
							<td class="{{ at.Room.StatusAbsentOut || 'Absent' }}" title="{{ at.Room.NoteOut }}">
								{{ (at.Room.TraineeOut | date: 'HH:mm:ss') || '-' }}
							</td>
							<td>{{ at.Rest.TimeOut || '-' }}</td>
							<td>{{ at.Rest.TimeIn || '-' }}</td>
							<td class="{{ at.Rest.StatusAbsentOut || 'Absent' }}" title="{{ at.Rest.NoteOut }}">
								{{ (at.Rest.TraineeOut | date: 'HH:mm:ss') || '-' }}
							</td>
							<td class="{{ at.Rest.StatusAbsentIn || 'Absent' }}" title="{{ at.Rest.NoteIn }}">
								{{ (at.Rest.TraineeIn | date: 'HH:mm:ss') || '-' }}
							</td>
							<td>
								<div *ngFor="let permission of at.AttendanceTimePermission">
									{{ permission.AttendanceDate | date: 'HH:mm:ss' }} -
									{{ permission.Reason }}
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</rd-card>
		</div>
	</div>
</div>
